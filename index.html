<html>
<head>
	<title>Test</title>
	<style type="text/css">
		body {
			padding: 0;
			margin: 0;
		}
		canvas {
			padding: 0;
			margin: 10px auto;
			border: 1px solid black;
		}
	</style>
</head>
<body>
<canvas width="512" height="512" id="canvas"></canvas>
<script type="text/javascript">
	var tileset = new Image();
	tileset.src = '20030921.jpg';

	function main() {
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');
		var map = {
			types: {
				wall: 1,
				free: 0
			},
			source: [
				[1, 1, 1, 1, 1, 1, 1, 1],
				[1, 0, 0, 0, 0, 0, 0, 1],
				[1, 0, 0, 0, 0, 0, 0, 1],
				[1, 0, 0, 0, 0, 0, 0, 1],
				[1, 0, 0, 0, 0, 0, 0, 1],
				[1, 0, 0, 0, 0, 0, 0, 1],
				[1, 0, 0, 0, 0, 0, 0, 1],
				[1, 1, 1, 1, 1, 1, 1, 1]
			],
            size: 1,
			compiled: []
		};

		//@todo x = w, y = h
		var cell 	= {x: canvas.width / map.source[0].length, y: canvas.height / map.source.length};

        console.log('cell');
		console.log(cell);

        function compileMap() {
			var dx = 0, dy = 0;
			for (var i in map.source) {
				for (var j in map.source[i]) {
					//4 dots
					//top line from left to right
					map.compiled.push({
						moveTo: {x: dx, y: dy},
						lineTo: {x: dx+cell.x, y: dy},
						type: map.source[i][j],
						draw_grid: true,
						map_index: [i, j]
					});
					//from-top-right-to-bottom
					map.compiled.push({
						moveTo: {x: dx+cell.x, y: dy},
						lineTo: {x: dx+cell.x, y: dy + cell.y},
						type: map.source[i][j],
						draw_grid: false,
						map_index: [i, j]
					});
					//from left-top-to-left-bottom
					map.compiled.push({
						moveTo: {x: dx, y: dy},
						lineTo: {x: dx, y: dy + cell.y},
						type: map.source[i][j],
						draw_grid: true,
						map_index: [i, j]
					});
					//from left-bottom-to-right-bottom
					map.compiled.push({
						moveTo: {x: dx, y: dy + cell.y},
						lineTo: {x: dx+cell.x, y: dy + cell.y},
						type: map.source[i][j],
						draw_grid: false,
						map_index: [i, j]
					});

					dx += cell.x;
				}

				dx = 0;
				dy += cell.y;
			}
		}

		compileMap();
		console.log(map);
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		function drawMapGrid() {
			ctx.strokeStyle = ctx.fillStyle = '#000';
			ctx.beginPath();
			for (var i in map.compiled) {

				var moveTo = map.compiled[i].moveTo;
				var lineTo = map.compiled[i].lineTo;
				//console.log('moveTo: ' + moveTo.x + ', ' + moveTo.y);
				//console.log('lineTo: ' + lineTo.x + ', ' + lineTo.y);
				if(map.compiled[i].draw_grid) {
					//console.log('draw');
					ctx.moveTo(moveTo.x, moveTo.y);
					ctx.lineTo(lineTo.x, lineTo.y);
				}
				else {
					//console.log('hidden');
				}
				//console.log('----');

			}
			ctx.stroke();
		}

		function selectTile(h, v) {
            var m = map.source;
            var w = map.types.wall;
            var bitMask = m[h][v];
            if(m[h-1] == undefined || m[h-1][v] == undefined || m[h-1][v] == w)  {
                bitMask += 1;
            }

            if(m[h-1] == undefined || m[h-1][v+1] == undefined || m[h-1][v+1] == w) {
                bitMask += 2;
            }

            if(m[h][v+1] == undefined || m[h][v+1] == w) {
                bitMask += 4;
            }
            if(m[h+1] == undefined || m[h+1][v+1] == undefined || m[h+1][v+1] == w) {
                bitMask += 8;
            }

            if(m[h+1] == undefined || m[h+1][v] == undefined || m[h+1][v] == w) {
                bitMask += 16;
            }

            if(m[h+1] == undefined || m[h+1][v-1] == undefined || m[h+1][v-1] == w) {
                bitMask += 32;
            }

            if(m[h][v-1]= undefined || m[h][v-1] == w) {
                bitMask += 64;
            }

            if(m[h-1] == undefined || m[h-1][v-1] == undefined || m[h-1][v-1] == w) {
                bitMask += 128;
            }


			var offsetX = 0;
			var offsetY = 0;
            if(bitMask == 184) {
                offsetX = cell.x;
            }
            if(bitMask == 232 || bitMask == 200 || bitMask == 208) {
                offsetX = cell.x * 3;
            }
            if(bitMask == 224) {
                offsetX = cell.x * 2;
            }
			return {x: offsetX, y: offsetY, i: h, j: v, id: bitMask};
		}

		function drawMapTextures() {

			var n = 0;
			while(n < map.compiled.length) {
				//4 points produce rect
				var p1 = map.compiled[n];
				var p2 = map.compiled[n+1];
				var p3 = map.compiled[n+2];
				var p4 = map.compiled[n+3];

				var w = Math.abs(p1.moveTo.x - p2.moveTo.x);
				var h = Math.abs(p3.moveTo.y - p4.moveTo.y);

                var tileOffset = selectTile(parseInt(p1.map_index[0]), parseInt(p1.map_index[1]));
                if(tileOffset) {
                    //console.log(tileOffset);
                    ctx.drawImage(tileset, tileOffset.x, tileOffset.y, cell.x, cell.y, p1.moveTo.x, p1.moveTo.y, cell.x, cell.y);
                    ctx.fillStyle = 'white';
                    ctx.font = '14px Arial';
                    ctx.fillText(tileOffset.id, p1.moveTo.x + 14, p1.moveTo.y + 20);
                }

				n += 4;
			}
		}

		drawMapGrid();
		drawMapTextures();


	};

	tileset.onload = function() {
		main();
	};
</script>
</body>
</html>